<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wahrheit oder Pflicht ‚Äì Spiel</title>
  <link rel="stylesheet" href="style_spiel-wop.css" />
  <link rel="icon" type="image/png" href="bilder/favicon-96x96.png" sizes="96x96" />
<style>
  :root {
    --btn-bg: #346bc2;
    --btn-bg-hover: #2959a8;
    --btn-text: #fff;
    --penalty-color: #c0392b;
    --choice-line-color-light: var(--btn-bg);
    --choice-line-color-dark: rgba(255, 255, 255, 0.75);
    --choice-text-color-light: var(--btn-bg);
    --choice-text-color-dark: rgba(255, 255, 255, 0.9);
    --male-color: #4A90E2;
    --female-color: #E94A84;
    --mixed-color: #777777;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --btn-bg: #2d4c7f;
      --btn-bg-hover: #3a5a99;
      --penalty-color: #e74c3c;
      --choice-line-color-light: #356890;
      --choice-line-color-dark: rgba(255, 255, 255, 0.75);
      --choice-text-color-light: #356890;
      --choice-text-color-dark: rgba(255, 255, 255, 0.9);
    }
  }

  .player-male { color: var(--male-color); }
  .player-female { color: var(--female-color); }
  .player-mixed { color: var(--mixed-color); }

  .fade-in {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: auto;
  }

  .fade-out {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: none;
  }

  .fade-slide-in {
    opacity: 1;
    transform: scale(1);
    transition: all 0.4s ease;
  }

  .fade-slide-out {
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.4s ease;
  }

  .mystery {
    animation: mysteryFade 0.6s ease forwards;
  }

  @keyframes mysteryFade {
    0% { opacity: 0; transform: scale(0.95) rotate(-2deg); filter: blur(4px); }
    60% { opacity: 0.5; transform: scale(1.02) rotate(1deg); filter: blur(2px); }
    100% { opacity: 1; transform: scale(1) rotate(0); filter: blur(0); }
  }

  .pulse {
    animation: pulseAnim 1.2s ease infinite;
  }

  @keyframes pulseAnim {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.08); opacity: 0.7; }
  }

  .zoom-glow {
    animation: zoomGlowAnim 1s ease;
  }

  @keyframes zoomGlowAnim {
    0% { transform: scale(1); text-shadow: none; }
    50% { transform: scale(1.3); text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
    100% { transform: scale(1); text-shadow: none; }
  }

  #truthBtn, #dareBtn, #doneBtn {
    padding: 0.7rem 1.4rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    background-color: var(--btn-bg);
    color: var(--btn-text);
    cursor: pointer;
    margin: 0.5rem;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }

  #truthBtn:hover:not(:disabled), #dareBtn:hover:not(:disabled), #doneBtn:hover:not(:disabled) {
    background-color: var(--btn-bg-hover);
    transform: scale(1.03);
  }

  #truthBtn:disabled, #dareBtn:disabled, #doneBtn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
    transform: none !important;
  }

  #penaltyBtn {
    background-color: transparent;
    border: 2.5px solid var(--penalty-color);
    color: var(--penalty-color);
    font-weight: 700;
    max-width: 160px;
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    font-size: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  #penaltyBtn:hover:not(:disabled) {
    background-color: var(--penalty-color);
    color: white;
  }

  #penaltyBtn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .straf-label {
    font-size: clamp(1.5rem, 5vw, 3rem);
    font-weight: bold;
    color: red;
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .choice-heading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    margin-top: 2rem;
    width: 100%;
    text-align: center;
  }

  .choice-heading {
      font-size: clamp(1.8rem, 5vw, 3rem);
      font-weight: 700;
      color: var(--choice-text-color-light);
      white-space: nowrap;
      margin: 0;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

  .current-player-name {
    font-weight: 900;
    font-size: clamp(1.6rem, 4vw, 2.8rem);
    white-space: nowrap;
  }

  .question-prompt-text {
    font-size: clamp(1.2rem, 4vw, 2rem);
    font-weight: 600;
    opacity: 0.85;
  }

  .action-btn.strafaufgabe {
    background-color: transparent;
    color: #555;
    font-size: 0.9rem;
    padding: 0.4rem 1rem;
    border-radius: 0.4rem;
    border: 1.5px solid #aaa;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
    align-self: center;
    max-width: 150px;
  }

  .action-btn.strafaufgabe:hover {
    background-color: #eee;
    color: #222;
    border-color: #888;
  }

  body.compact-header header {
    padding: 0.8rem 0;
    animation: headerShrink 0.4s ease forwards;
    transition: padding 0.4s ease;
  }

  body.compact-header .header-inner .logo,
  body.compact-header .header-inner .icon-right {
    font-size: 1.6rem;
    transition: font-size 0.4s ease;
  }

  body.compact-header header h1 {
    font-size: 1.3rem;
    transition: font-size 0.4s ease;
  }

  body.compact-header .title-group .subtitle {
    display: none;
  }

  body.compact-header .container {
    margin-top: 1.2rem;
    transition: margin-top 0.3s ease;
  }

  body.compact-header .question-box {
    padding: 1.2rem;
    transition: padding 0.3s ease, font-size 0.3s ease;
  }

  @keyframes headerShrink {
    from { transform: scaleY(1); }
    to { transform: scaleY(0.92); }
  }

  @keyframes headerUnshrink {
    from { transform: scaleY(0.92); }
    to { transform: scaleY(1); }
  }

  @media screen and (max-height: 600px) and (min-width: 768px) {
    body.compact-header header {
      padding: 0.6rem 0;
    }

    body.compact-header header h1 {
      font-size: 1.1rem;
    }

    body.compact-header .question-box {
      font-size: 1.05rem;
      padding: 1rem;
    }
  }

  @keyframes textWipeOut {
    0% { opacity: 1; transform: translateX(0); }
    100% { opacity: 0; transform: translateX(-40px); }
  }

  @keyframes textWipeIn {
    0% { opacity: 0; transform: translateX(40px); }
    100% { opacity: 1; transform: translateX(0); }
  }

  .prompt-text-anim-out {
    animation: textWipeOut 0.35s ease forwards;
  }

  .prompt-text-anim-in {
    animation: textWipeIn 0.4s ease forwards;
  }

  @media (prefers-color-scheme: dark) {
    .choice-heading {
      color: var(--choice-text-color-dark);
    }
  }
</style>
</head>
<body>
  <header>
    <div class="header-inner" style="display:flex; align-items:center; gap:1rem; padding: 0 1.5rem;">
      <div class="logo">üîÆ</div>
      <div class="title-group">
        <h1 style="margin:0; font-weight:700; font-size:1.8rem;">Wahrheit oder Pflicht</h1>
        <p class="subtitle" style="margin:0; opacity:0.85;">W√§hle Wahrheit oder Pflicht und lass dich √ºberraschen!</p>
      </div>
      <div class="icon-right" style="margin-left:auto; font-size:1.6rem;">ü§ê</div>
    </div>
  </header>
  <main>
    <div class="container">

      <h2 id="choiceHeading" class="choice-heading fade-in" style="flex-direction: column; text-align: center;">
        <span id="currentPlayerName" class="current-player-name player-mixed"></span>
        <span id="questionPromptText">Wahrheit oder Pflicht?</span>
      </h2>

      <div id="modeSelection" class="mode-selection fade-in" aria-live="polite">
        <button id="truthBtn" type="button">Wahrheit</button>
        <button id="dareBtn" type="button">Pflicht</button>
      </div>

      <div id="questionView" class="question-view fade-out" style="display:none;">
        <div class="category-label" id="categoryLabel"></div>
        <div id="penaltyHeading" class="straf-label mystery" style="display:none;">STRAFAUFGABE</div>
        <div class="question-box" id="questionBox">Frage erscheint hier...</div>
        <div class="action-buttons" style="margin-top:1rem; display:flex; justify-content:center; gap:1rem;">
          <button id="doneBtn">Erledigt / N√§chste Frage</button>
          <button id="penaltyBtn" class="action-btn strafaufgabe">Strafaufgabe</button>
        </div>
      </div>

      <button id="backBtn" class="back-button" style="margin-top:2rem;">Zur√ºck zur Startseite</button>
    </div>
  </main>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const modeSelection = document.getElementById("modeSelection");
  const questionView = document.getElementById("questionView");
  const categoryLabel = document.getElementById("categoryLabel");
  const penaltyHeading = document.getElementById("penaltyHeading");
  const questionBox = document.getElementById("questionBox");
  const doneBtn = document.getElementById("doneBtn");
  const penaltyBtn = document.getElementById("penaltyBtn");
  const backBtn = document.getElementById("backBtn");
  const currentPlayerName = document.getElementById("currentPlayerName");
  const questionPromptText = document.getElementById("questionPromptText");
  const choiceHeading = document.getElementById("choiceHeading");

  let wopQuestions = {};
  let wopPlayers = [];
  let playerQueue = [];
  let currentPlayer = null;
  let currentQuestion = null;
  let isPenaltyActive = false;

  // Hilfsfunktion: Animation mit Promises warten
  function waitForAnimation(el, animationName) {
    return new Promise(resolve => {
      function onAnimEnd(e) {
        if (e.animationName === animationName) {
          el.removeEventListener("animationend", onAnimEnd);
          resolve();
        }
      }
      el.addEventListener("animationend", onAnimEnd);
    });
  }

  // Hilfsfunktion: Fade-Out, dann callback, dann Fade-In
  async function fadeSwitch(outEl, inEl, delay = 400) {
    // Fade Out outEl
    outEl.classList.remove("fade-in");
    outEl.classList.add("fade-out");
    await new Promise(r => setTimeout(r, delay));

    // Hide outEl, Show inEl
    outEl.style.display = "none";
    inEl.style.display = "block";

    // Fade In inEl
    inEl.classList.remove("fade-out");
    inEl.classList.add("fade-in");
  }

  // Button-Enable/Disable f√ºr mehrere Buttons
  function setButtonsDisabled(state) {
    [doneBtn, penaltyBtn, truthBtn, dareBtn].forEach(btn => {
      btn.disabled = state;
    });
  }

  // Namenratter Animation
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function nameRattern(duration = 2200, interval = 50) {
    if (wopPlayers.length === 0) return;
    let elapsed = 0;
    while (elapsed < duration) {
      const randomPlayer = wopPlayers[Math.floor(Math.random() * wopPlayers.length)];
      currentPlayerName.textContent = randomPlayer.name;
      currentPlayerName.className = `current-player-name player-${randomPlayer.gender}`;
      currentPlayerName.classList.add("zoom-glow");
      await sleep(interval);
      elapsed += interval;
    }
    currentPlayerName.classList.remove("zoom-glow");
  }

  // Spieler in Queue zuf√§llig mischen
  function shufflePlayers(players) {
    for (let i = players.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [players[i], players[j]] = [players[j], players[i]];
    }
    return players;
  }

  function initPlayerQueue() {
    playerQueue = shufflePlayers(wopPlayers.slice());
  }

  function getNextPlayer() {
    if (playerQueue.length === 0) {
      initPlayerQueue();
    }
    return playerQueue.shift();
  }

  // Fragen laden aus JSON-Datei
  async function loadQuestions() {
    try {
      const response = await fetch("JSON/wop.json");
      if (!response.ok) throw new Error("Fehler beim Laden der Fragen");
      const data = await response.json();
      wopQuestions = data;
    } catch (e) {
      alert("Fehler beim Laden der Fragen: " + e.message);
    }
  }

  // Spieler laden aus localStorage
  function loadPlayersFromStorage() {
    const storedPlayers = localStorage.getItem("wopPlayers");
    if (storedPlayers) {
      try {
        wopPlayers = JSON.parse(storedPlayers);
      } catch {
        wopPlayers = [];
      }
    } else {
      // Beispielspieler fallback
      wopPlayers = [
        { name: "Anna", gender: "female" },
        { name: "Ben", gender: "male" },
        { name: "Chris", gender: "mixed" }
      ];
    }
  }

  // Pools f√ºr Wahrheit und Pflicht aufbauen (flach)
  function buildQuestionPools() {
    let wahrheitPool = [];
    let pflichtPool = [];

    for (const catKey in wopQuestions) {
      if (!wopQuestions.hasOwnProperty(catKey)) continue;
      const cat = wopQuestions[catKey];

      if (Array.isArray(cat.wahrheit)) {
        // Filter kann hier erweitert werden, z.B. Geschlecht
        wahrheitPool.push(...cat.wahrheit.map(q => ({...q, category: cat.label})));
      }
      if (Array.isArray(cat.pflicht)) {
        pflichtPool.push(...cat.pflicht.map(q => ({...q, category: cat.label})));
      }
    }
    return { wahrheitPool, pflichtPool };
  }

  // Frage anzeigen
  function showQuestion(questionObj, isPenalty = false) {
    if (!questionObj) return;

    isPenaltyActive = isPenalty;
    penaltyHeading.style.display = isPenalty ? "block" : "none";

    categoryLabel.textContent = questionObj.category || "";
    questionBox.textContent = questionObj.frage || questionObj.text || questionObj.gruppentext || "Frage fehlt";

    // Kategorie-Label animieren
    categoryLabel.classList.add("pulse");
    setTimeout(() => categoryLabel.classList.remove("pulse"), 1300);

    // Strafaufgaben-Mystery-Animation
    if (isPenalty) {
      questionBox.classList.add("mystery");
      setTimeout(() => questionBox.classList.remove("mystery"), 800);
    } else {
      questionBox.classList.remove("mystery");
    }
  }

  // UI wechseln: Von Auswahl zu Frage
  async function showQuestionView() {
    setButtonsDisabled(true);
    await fadeSwitch(modeSelection, questionView);
    setButtonsDisabled(false);
  }

  // UI wechseln: Von Frage zur√ºck zu Auswahl
  async function showModeSelectionView() {
    setButtonsDisabled(true);
    await fadeSwitch(questionView, modeSelection);
    setButtonsDisabled(false);
  }

  // Hauptspiel-Logik starten
  async function startNameSelection() {
    setButtonsDisabled(true);

    questionPromptText.textContent = "Wer ist dran?";
    categoryLabel.textContent = "";
    questionBox.textContent = "";

    // Modus-UI ausblenden, Wahl√ºberschrift bleibt sichtbar mit "Wer ist dran?"
    modeSelection.classList.remove("fade-in");
    modeSelection.classList.add("fade-out");
    await new Promise(r => setTimeout(r, 400));
    modeSelection.style.display = "none";

    currentPlayerName.style.opacity = "0";
    currentPlayerName.style.display = "block";

    // Namensratter-Animation
    await nameRattern();

    // Richtigen Spieler ziehen
    currentPlayer = getNextPlayer();
    currentPlayerName.textContent = currentPlayer.name;
    currentPlayerName.className = `current-player-name player-${currentPlayer.gender}`;

    // Zoom-Glow auf den Spieler
    currentPlayerName.classList.add("zoom-glow");
    await new Promise(r => setTimeout(r, 1200));
    currentPlayerName.classList.remove("zoom-glow");

    // Kurze Pause vor Frageaufforderung
    await new Promise(r => setTimeout(r, 400));

    // Wechsel zur Auswahl Wahrheit/Pflicht mit Animation
    currentPlayerName.style.opacity = "1";
    questionPromptText.classList.add("prompt-text-anim-out");
    await new Promise(r => setTimeout(r, 350));
    questionPromptText.textContent = "Wahrheit oder Pflicht?";
    questionPromptText.classList.remove("prompt-text-anim-out");
    questionPromptText.classList.add("prompt-text-anim-in");
    await new Promise(r => setTimeout(r, 400));
    questionPromptText.classList.remove("prompt-text-anim-in");

    // Auswahl-Buttons einblenden
    modeSelection.style.display = "flex";
    modeSelection.classList.remove("fade-out");
    modeSelection.classList.add("fade-in");
    setButtonsDisabled(false);
  }

  // Variablen f√ºr Fragenpools
  let wahrheitPool = [];
  let pflichtPool = [];

  // Frage zuf√§llig aus Pool ausw√§hlen & entfernen
  function getRandomQuestion(pool) {
    if (pool.length === 0) return null;
    const idx = Math.floor(Math.random() * pool.length);
    return pool.splice(idx, 1)[0];
  }

  // Wahrheit-Button gedr√ºckt
  async function onTruth() {
    setButtonsDisabled(true);
    isPenaltyActive = false;
    currentQuestion = getRandomQuestion(wahrheitPool);
    if (!currentQuestion) {
      alert("Keine Wahrheitsfragen mehr verf√ºgbar!");
      setButtonsDisabled(false);
      return;
    }
    showQuestion(currentQuestion, false);
    await fadeSwitch(modeSelection, questionView);
    setButtonsDisabled(false);
  }

  // Pflicht-Button gedr√ºckt
  async function onDare() {
    setButtonsDisabled(true);
    isPenaltyActive = false;
    currentQuestion = getRandomQuestion(pflichtPool);
    if (!currentQuestion) {
      alert("Keine Pflichtfragen mehr verf√ºgbar!");
      setButtonsDisabled(false);
      return;
    }
    showQuestion(currentQuestion, false);
    await fadeSwitch(modeSelection, questionView);
    setButtonsDisabled(false);
  }

  // Strafaufgabe-Button gedr√ºckt
  function onPenalty() {
    if (!currentQuestion) return;
    // Strafaufgabe anzeigen, falls vorhanden (gruppentext bevorzugt)
    const penaltyQuestion = currentQuestion.gruppentext
      ? { ...currentQuestion, frage: currentQuestion.gruppentext }
      : currentQuestion;
    showQuestion(penaltyQuestion, true);
  }

  // N√§chste Frage / Erledigt gedr√ºckt
  async function onDone() {
    setButtonsDisabled(true);
    await fadeSwitch(questionView, modeSelection);
    currentQuestion = null;
    isPenaltyActive = false;
    // Direkt neu starten Name Auswahl
    await startNameSelection();
    setButtonsDisabled(false);
  }

  // Initial Setup
  async function init() {
    loadPlayersFromStorage();
    await loadQuestions();
    ({ wahrheitPool, pflichtPool } = buildQuestionPools());
    initPlayerQueue();
    currentPlayer = null;

    // UI vorbereiten
    questionView.style.display = "none";
    modeSelection.style.display = "flex";
    setButtonsDisabled(false);

    // Starte erste Namensauswahl
    await startNameSelection();
  }

  // Event Listener
  const truthBtn = document.getElementById("truthBtn");
  const dareBtn = document.getElementById("dareBtn");

  truthBtn.addEventListener("click", onTruth);
  dareBtn.addEventListener("click", onDare);
  penaltyBtn.addEventListener("click", onPenalty);
  doneBtn.addEventListener("click", onDone);

  backBtn.addEventListener("click", () => {
    location.reload();
  });

  // Starte das Spiel
  await init();
});
</script>
  
</body>
</html>
