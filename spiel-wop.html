<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wahrheit oder Pflicht ‚Äì Spiel</title>
  <link rel="stylesheet" href="style-spiel.css" />
  <link rel="icon" type="image/png" href="bilder/favicon-96x96.png" sizes="96x96" />
  <style>
    .fade-in {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: auto;
    }
    .fade-out {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: none;
      user-select: none;
    }
    .action-btn.strafaufgabe {
      background-color: transparent;
      color: #555;
      font-size: 0.9rem;
      padding: 0.4rem 1rem;
      border-radius: 0.4rem;
      border: 1.5px solid #aaa;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      align-self: center;
      max-width: 150px;
    }
    .action-btn.strafaufgabe:hover {
      background-color: #eee;
      color: #222;
      border-color: #888;
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="logo">üîÆ</div>
    <div class="title-group">
      <h1>Wahrheit oder Pflicht</h1>
      <p class="subtitle">W√§hle Wahrheit oder Pflicht und lass dich √ºberraschen!</p>
    </div>
    <div class="icon-right">ü§ê</div>
  </div>
</header>
<main>
  <div class="container">
    <div id="modeSelection" class="mode-selection fade-in">
      <button id="truthBtn">Wahrheit</button>
      <button id="dareBtn">Pflicht</button>
    </div>
    <div id="questionView" class="question-view fade-out" style="display:none;">
      <div class="category-label" id="categoryLabel"></div>
      <div class="question-box" id="questionBox">Frage erscheint hier...</div>
      <div class="action-buttons">
        <button id="doneBtn">Erledigt / N√§chste Frage</button>
        <button id="penaltyBtn" class="action-btn strafaufgabe">Strafaufgabe</button>
      </div>
    </div>
    <button id="backBtn" class="back-button">Zur√ºck zur Startseite</button>
  </div>
</main>
<script>
let fragenKategorien = {};
let aktiveKategorien = [];

let aktuelleKategorie = "";
let aktuelleFrage = "";
let aktuellerModus = "";
let istStrafaufgabeAktiv = false;

const modeSelection = document.getElementById("modeSelection");
const questionView = document.getElementById("questionView");
const truthBtn = document.getElementById("truthBtn");
const dareBtn = document.getElementById("dareBtn");
const categoryLabel = document.getElementById("categoryLabel");
const penaltyHeading = document.getElementById("penaltyHeading");
const questionBox = document.getElementById("questionBox");
const doneBtn = document.getElementById("doneBtn");
const penaltyBtn = document.getElementById("penaltyBtn");
const backBtn = document.getElementById("backBtn");

// Lade Kategorien aus sessionStorage
function ladeAktiveKategorien() {
  const gespeicherteKategorien = sessionStorage.getItem("wopKategorien");
  if (gespeicherteKategorien) {
    try {
      aktiveKategorien = JSON.parse(gespeicherteKategorien);
    } catch {
      aktiveKategorien = [];
    }
  } else {
    aktiveKategorien = [];
  }
}

// Hilfsfunktion zum FadeIn / FadeOut
function fadeOut(element) {
  return new Promise(resolve => {
    element.classList.remove("fade-in");
    element.classList.add("fade-out");
    setTimeout(() => {
      element.style.display = "none";
      resolve();
    }, 400);
  });
}
function fadeIn(element, extraClass = "") {
  return new Promise(resolve => {
    element.style.display = "flex";
    element.classList.remove("fade-out");
    if (extraClass) {
      element.classList.add(extraClass);
      setTimeout(() => element.classList.remove(extraClass), 1200);
    }
    element.classList.add("fade-in");
    resolve();
  });
}

// Frage aus den aktiven Kategorien holen
function getRandomQuestion(modus) {
  // Wenn keine aktive Kategorie, nimm alle Kategorien
  const pool = aktiveKategorien.length === 0 ? Object.keys(fragenKategorien) : aktiveKategorien;

  // W√§hle zuf√§llige Kategorie aus Pool
  const catKey = pool[Math.floor(Math.random() * pool.length)];
  const cat = fragenKategorien[catKey];

  if (!cat) {
    return { label: "", frage: "Keine Fragen verf√ºgbar." };
  }

  const fragenArray = modus === "wahrheit" ? cat.wahrheit : cat.pflicht;
  if (!fragenArray || fragenArray.length === 0) {
    return { label: cat.label, frage: "Keine Fragen in dieser Kategorie." };
  }
  const frage = fragenArray[Math.floor(Math.random() * fragenArray.length)];
  return { label: cat.label, frage };
}

// Spiel starten
async function startRound(modus) {
  aktuellerModus = modus;
  istStrafaufgabeAktiv = false;
  penaltyHeading.style.display = "none";
  penaltyBtn.style.display = modus === "wahrheit" ? "inline-block" : "none";

  await fadeOut(modeSelection);

  const { label, frage } = getRandomQuestion(modus);
  aktuelleKategorie = label;
  aktuelleFrage = frage;
  categoryLabel.textContent = label;
  questionBox.textContent = frage;

  await fadeIn(questionView);

  doneBtn.style.display = "inline-block";
  backBtn.style.display = "inline-block";
}

// N√§chste Frage
async function nextRound() {
  istStrafaufgabeAktiv = false;
  await fadeOut(questionView);
  await fadeIn(modeSelection);
  backBtn.style.display = "none";
}

// Strafaufgabe zeigen
async function showStrafaufgabe() {
  istStrafaufgabeAktiv = true;
  await fadeOut(questionView);

  // Strafaufgaben aus allen Pflicht-Fragen aller Kategorien (ungeachtet aktiver Kategorien)
  const allPflicht = Object.values(fragenKategorien).flatMap(cat => cat.pflicht);
  const randomPflicht = allPflicht[Math.floor(Math.random() * allPflicht.length)];

  categoryLabel.textContent = "";
  penaltyHeading.style.display = "block";
  questionBox.textContent = randomPflicht;
  penaltyBtn.style.display = "none";

  await fadeIn(questionView, "mystery");

  doneBtn.style.display = "inline-block";
  backBtn.style.display = "inline-block";
}

// EventListener Setup nach JSON laden
function setupEventListeners() {
  truthBtn.addEventListener("click", () => startRound("wahrheit"));
  dareBtn.addEventListener("click", () => startRound("pflicht"));
  doneBtn.addEventListener("click", nextRound);
  penaltyBtn.addEventListener("click", showStrafaufgabe);
  backBtn.addEventListener("click", () => {
    window.location.href = "index.html";
  });
}

// JSON laden und Setup starten
fetch("JSON/wop.json")
  .then(response => response.json())
  .then(data => {
    fragenKategorien = data;
    ladeAktiveKategorien();
    modeSelection.style.display = "flex";
    // backBtn.style.display = "none"; // <-- auskommentiert oder entfernt
    setupEventListeners();
  })
  .catch(err => {
    console.error("Fehler beim Laden der Fragen JSON:", err);
    modeSelection.style.display = "flex";
    // backBtn.style.display = "none"; // <-- auskommentiert oder entfernt
    setupEventListeners();
  });

// ...

async function nextRound() {
  istStrafaufgabeAktiv = false;
  await fadeOut(questionView);
  await fadeIn(modeSelection);
  // backBtn.style.display = "none"; // <-- NICHT mehr verstecken
}

// Auch bei startRound den backBtn nicht verstecken:

async function startRound(modus) {
  aktuellerModus = modus;
  istStrafaufgabeAktiv = false;
  penaltyHeading.style.display = "none";
  penaltyBtn.style.display = modus === "wahrheit" ? "inline-block" : "none";

  await fadeOut(modeSelection);

  const { label, frage } = getRandomQuestion(modus);
  aktuelleKategorie = label;
  aktuelleFrage = frage;
  categoryLabel.textContent = label;
  questionBox.textContent = frage;

  await fadeIn(questionView);

  doneBtn.style.display = "inline-block";
}
</script>
</body>
</html>
